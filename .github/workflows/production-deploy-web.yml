name: Deploy Web to Production

on:
  workflow_call:
    inputs:
      commit_hash_or_tag:
        description: The commit SHA that you wish to revert to
        type: string
        default: 'main'

jobs:
  release-web:
    name: Deploy Web to Production
    strategy:
      matrix:
        include:
          - brand: 'blc-uk'
            brand_url: 'bluelightcard.co.uk'
            identity_brand: 'blc_uk'
            identity_api_key: 'IDENTITY_EU_WEST_2_API_KEY'
            identity_api_url: 'https://identity.blcshine.io'
            region: 'eu-west-2'
            amplitude_deployment_key: 'BLC_UK_AMPLITUDE_DEPLOYMENT_KEY'
            cognito_client_id: 'BLC_UK_COGNITO_CLIENT_ID'
            cognito_client_secret: 'BLC_UK_COGNITO_CLIENT_SECRET'
            offers_graphql_endpoint: 'https://27d2m22mtvac5cvilrvb7kviyi.appsync-api.eu-west-2.amazonaws.com/graphql'
            offers_api_gateway_endpoint: 'https://offers.blcshine.io'
            offers_brand: 'blc-uk'
            zendesk_url: 'https://bluelightcard.zendesk.com/hc/en-gb/signin'
            auth0_login_url: 'https://access.blcshine.io/authorize?response_type=code&client_id=pU6O3irGF7dKqSmFHXyzvogwH4gEmkyz&redirect_uri=https://www.bluelightcard.co.uk/auth/callback.php%3Fprovider%3Dauth0&scope=offline_access%20openid%20profile%20email'
            auth0_logout_url: 'https://access.blcshine.io/logout?returnTo=https%3A%2F%2Fwww.bluelightcard.co.uk%2Flogout.php'
            auth0_domain: 'access.blcshine.io'
            auth0_redirect_url: 'https://www.bluelightcard.co.uk/auth/callback.php%3Fprovider%3Dauth0'
            auth0_client_id: 'pU6O3irGF7dKqSmFHXyzvogwH4gEmkyz'
            auth0_client_secret: 'BLC_UK_AUTH0_CLIENT_SECRET'
            stripe_publishable_key: 'pk_live_ZADbD9UHEB5dAv9vBQpYM6UW'
            currency_symbol: '£'
            membership_price: '4.99'
            fsiCompanyIds: '38142, 41155, 41286'
          - brand: 'blc-au'
            brand_url: 'bluelightcard.com.au'
            identity_brand: 'blc_au'
            identity_api_key: 'IDENTITY_AP_SOUTHEAST_2_API_KEY'
            identity_api_url: 'https://identity-au.blcshine.io'
            region: 'ap-southeast-2'
            amplitude_deployment_key: 'BLC_AU_AMPLITUDE_DEPLOYMENT_KEY'
            cognito_client_id: 'BLC_AU_COGNITO_CLIENT_ID'
            cognito_client_secret: 'BLC_AU_COGNITO_CLIENT_SECRET'
            offers_graphql_endpoint: 'https://rbwzvcibffepbhnfndd5xam6l4.appsync-api.ap-southeast-2.amazonaws.com/graphql'
            offers_api_gateway_endpoint: 'https://offers-au.blcshine.io'
            offers_brand: 'blc-aus'
            auth0_login_url: 'https://access-au.blcshine.io/authorize?response_type=code&client_id=IE1gORi8ZUHdy8gUoEOLRT9bEHjso0SM&redirect_uri=https://www.bluelightcard.com.au/auth/callback.php%3Fprovider%3Dauth0&scope=offline_access%20openid%20profile%20email'
            auth0_logout_url: 'https://access-au.blcshine.io/logout?returnTo=https%3A%2F%2Fwww.bluelightcard.com.au%2Flogout.php'
            auth0_domain: 'access-au.blcshine.io'
            auth0_redirect_url: 'https://www.bluelightcard.com.au/auth/callback.php%3Fprovider%3Dauth0'
            auth0_client_id: 'IE1gORi8ZUHdy8gUoEOLRT9bEHjso0SM'
            auth0_client_secret: 'BLC_AU_AUTH0_CLIENT_SECRET'
            stripe_publishable_key: 'pk_live_51LLwlnKV9X4dfU6lCzTMukXhQkEca1VkVQPzQjmUqBAg5lDx2Pi1b4S1a9zaih6etCdXod22vL44Vvo6vELcW7x800Uw7cWM3i'
            currency_symbol: '$'
            membership_price: '4.99'
            fsiCompanyIds: ''
          - brand: 'dds-uk'
            brand_url: 'defencediscountservice.co.uk'
            identity_brand: 'dds_uk'
            identity_api_key: 'IDENTITY_EU_WEST_2_API_KEY'
            identity_api_url: 'https://identity.blcshine.io'
            region: 'eu-west-2'
            amplitude_deployment_key: 'DDS_UK_AMPLITUDE_DEPLOYMENT_KEY'
            cognito_client_id: 'DDS_UK_COGNITO_CLIENT_ID'
            cognito_client_secret: 'DDS_UK_COGNITO_CLIENT_SECRET'
            offers_graphql_endpoint: 'https://bseyuukkyrcnrmpbnpq5vehowy.appsync-api.eu-west-2.amazonaws.com/graphql'
            offers_api_gateway_endpoint: 'https://offers-dds-uk.blcshine.io'
            offers_brand: 'dds-uk'
            auth0_login_url: 'https://access-dds.blcshine.io/authorize?response_type=code&client_id=j2IUeRhSBUO1ySiSHi8YZ4NEifaHv40p&redirect_uri=https://www.defencediscountservice.co.uk/auth/callback.php%3Fprovider%3Dauth0&scope=offline_access%20openid%20profile%20email'
            auth0_logout_url: 'https://access-dds.blcshine.io/logout?returnTo=https%3A%2F%2Fwww.defencediscountservice.co.uk%2Flogout.php'
            auth0_domain: 'access-dds.blcshine.io'
            auth0_redirect_url: 'https://www.defencediscountservice.co.uk/auth/callback.php%3Fprovider%3Dauth0'
            auth0_client_id: 'j2IUeRhSBUO1ySiSHi8YZ4NEifaHv40p'
            auth0_client_secret: 'DDS_UK_AUTH0_CLIENT_SECRET'
            stripe_publishable_key: 'pk_live_51LMpvQIvjtDL9My5OBGmtfhXZHtgP3nDdDnBF10zSOPHXGg66aAy0aT8KgDKyNu9prQGATto5Fu9v2OVrFvk7fvj00uybc1zZe'
            currency_symbol: '£'
            membership_price: '4.99'
            fsiCompanyIds: ''
    environment: Production
    runs-on: ubuntu-latest
    env:
      NEXT_PUBLIC_API_PROXY_URL: https://api.bluelightcard.workers.dev
      NEXT_PUBLIC_AMPLITUDE_API_KEY: ${{ secrets.AMPLITUDE_API_KEY }}
      NEXT_PUBLIC_AMPLITUDE_DEPLOYMENT_KEY: ${{ secrets[matrix.amplitude_deployment_key] }}
      NEXT_PUBLIC_OFFERS_ENDPOINT: ${{matrix.offers_graphql_endpoint}}
      NEXT_PUBLIC_OFFERS_API_GATEWAY_ENDPOINT: ${{matrix.offers_api_gateway_endpoint}}
      NEXT_PUBLIC_OFFERS_BRAND: ${{matrix.offers_brand}}
      NEXT_PUBLIC_BLACK_FRIDAY_TIME_LOCK_START_DATE: '2023-11-24T01:00:00'
      NEXT_PUBLIC_BLACK_FRIDAY_TIME_LOCK_END_DATE: '2023-11-27T23:59:59'
      NEXT_PUBLIC_IDENTITY_API_URL: ${{matrix.identity_api_url}}
      NEXT_PUBLIC_IDENTITY_API_KEY: ${{ secrets[matrix.identity_api_key] }}
      NEXT_PUBLIC_USER_PROFILE_ENDPOINT: /user
      NEXT_PUBLIC_ORGANISATION_ENDPOINT: /${{matrix.identity_brand}}/organisation
      NEXT_PUBLIC_ELIGIBILITY_FORM_OUTPUT_ENDPOINT: /${{matrix.identity_brand}}/formOutputData
      NEXT_PUBLIC_SEARCH_ENDPOINT: https://x26st9km9b.execute-api.eu-west-2.amazonaws.com/production
      NEXT_PUBLIC_RETRIEVE_FAVOURITE_ENDPOINT: https://ysgt36ldck.execute-api.eu-west-2.amazonaws.com/production/Favourites/retrieve
      NEXT_PUBLIC_UPDATE_FAVOURITE_ENDPOINT: https://ysgt36ldck.execute-api.eu-west-2.amazonaws.com/production/Favourites/update
      NEXT_PUBLIC_RETRIEVE_OFFER_ENDPOINT: https://h9to9ist4k.execute-api.eu-west-2.amazonaws.com/v1/offers/
      NEXT_PUBLIC_APP_MICROSERVICE_BRAND: BLC
      NEXT_PUBLIC_COGNITO_CLIENT_REGION: ${{matrix.region}}
      NEXT_PUBLIC_COGNITO_CLIENT_ID: ${{ secrets[matrix.cognito_client_id] }}
      NEXT_PUBLIC_COGNITO_CLIENT_SECRET: ${{ secrets[matrix.cognito_client_secret] }}
      NEXT_PUBLIC_FLAGSMITH_KEY: ${{ secrets.FLAGSMITH_KEY }}
      NEXT_PUBLIC_COGNITO_LOGIN_URL: https://auth.blcshine.io/login?client_id=7b854of9jqjte75vglfnm1gd3t&response_type=code&scope=aws.cognito.signin.user.admin+email+openid+profile&redirect_uri=https%3A%2F%2Fwww.bluelightcard.co.uk%2Fauth%2Fcallback.php
      NEXT_PUBLIC_COGNITO_LOGOUT_URL: https://auth.blcshine.io/logout?client_id=7b854of9jqjte75vglfnm1gd3t&response_type=code&scope=aws.cognito.signin.user.admin+email+openid+profile&redirect_uri=https%3A%2F%2Fwww.bluelightcard.co.uk%2Fauth%2Fcallback.php&logout_uri=https%3A%2F%2Fwww.bluelightcard.co.uk%2Flogout.php
      NEXT_PUBLIC_AUTH0_LOGIN_URL: ${{matrix.auth0_login_url}}
      NEXT_PUBLIC_AUTH0_LOGOUT_URL: ${{matrix.auth0_logout_url}}
      NEXT_PUBLIC_AUTH0_DOMAIN: ${{matrix.auth0_domain}}
      NEXT_PUBLIC_AUTH0_CLIENT_ID: ${{matrix.auth0_client_id}}
      NEXT_PUBLIC_AUTH0_CLIENT_SECRET: ${{secrets[matrix.auth0_client_secret]}}
      NEXT_PUBLIC_AUTH0_REDIRECT_URL: ${{matrix.auth0_redirect_url}}
      NEXT_PUBLIC_BRAZE_SDK_ENDPOINT: sdk.fra-02.braze.eu
      NEXT_PUBLIC_BRAZE_SDK_API_KEY: ${{ secrets.BRAZE_SDK_API_KEY }}
      NEXT_PUBLIC_AMPLITUDE_EXPERIMENT_REDEMPTION_VAULT_WEB: offer-sheet-redeem-vault-search-and-homepage-web-2
      NEXT_PUBLIC_BRAND_URL: ${{matrix.brand_url}}
      NEXT_ZENDESK_V1_BLC_UK_URL: ${{ matrix.zendesk_url }}
      NEXT_PUBLIC_STRIPE_KEY: ${{matrix.stripe_publishable_key}}
      NEXT_PUBLIC_CURRENCY_SYMBOL: ${{matrix.currency_symbol}}
      NEXT_PUBLIC_MEMBERSHIP_PRICE: ${{matrix.membership_price}}
      NEXT_PUBLIC_FSI_COMPANY_IDS: ${{matrix.fsiCompanyIds}}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.commit_hash_or_tag }}
      - name: Setup
        uses: ./.github/actions/setup
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: remove mock login
        run: rm -rf packages/web/src/pages/mock-login.tsx
      - name: Generate SST Types
        env:
          BRAND: BLC_UK
        run: npx sst types --stage production
      - name: Copy associated file for brand
        working-directory: ./packages/web
        run: cp ./assets/ios-assoc/apple-app-site-association-${{ matrix.brand }} ./public/.well-known
      - name: Build
        run: NEXT_PUBLIC_APP_BRAND=${{matrix.brand}} npm run build -w packages/web
      - name: Configure Headers
        run: cp packages/web/_headers packages/web/dist
      - name: Publish
        uses: cloudflare/pages-action@1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{matrix.brand}}
          branch: 'main'
          directory: packages/web/out
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
      - name: Datadog deployment metrics
        uses: ./.github/actions/datadog
        with:
          environment: 'production'
          service_name: 'web'
          workflow_run_id: ${{ github.run_id }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DATADOG_DORA_METRICS_CLIENT_TOKEN: ${{ secrets.DATADOG_DORA_METRICS_CLIENT_TOKEN }}
      - name: Send Slack message on failure
        if: ${{ failure() }}
        uses: bluelightcard/github-actions-slack-notification@v1
        with:
          webhook_url: ${{ secrets.CI_FAILURE_NOTIFICATIONS_WEBHOOK }}
          title: '@here :x: Production deployment failed for Web (${{matrix.brand}})!'
      - name: Send Slack message on success
        if: ${{ success() }}
        uses: bluelightcard/github-actions-slack-notification@v1
        with:
          webhook_url: ${{ secrets.CI_SUCCESS_NOTIFICATIONS_WEBHOOK }}
          title: ':rocket: Production deployment for Web (${{matrix.brand}}) was successful!'
